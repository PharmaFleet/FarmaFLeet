# Alembic Migrations Documentation

This document provides comprehensive documentation for all database migrations in the PharmaFleet delivery management system.

## Table of Contents

1. [Migration Overview](#migration-overview)
2. [Migration Chain](#migration-chain)
3. [Individual Migrations](#individual-migrations)
4. [How to Run Migrations](#how-to-run-migrations)
5. [Common Issues and Troubleshooting](#common-issues-and-troubleshooting)
6. [Recommendations](#recommendations)

---

## Migration Overview

The PharmaFleet system uses Alembic for database migrations with async SQLAlchemy support. The migrations are designed for PostgreSQL with PostGIS (GeoAlchemy2) for spatial data handling.

**Total Migrations:** 8
**Initial Schema Created:** January 22, 2026
**Latest Migration:** February 5, 2026

### Key Dependencies

- PostgreSQL with PostGIS extension
- GeoAlchemy2 for spatial types (`Geometry(POINT, 4326)`)
- Supabase PostgreSQL with PgBouncer (requires `statement_cache_size=0`)

---

## Migration Chain

```
0ad0e83f95f1 (Initial Schema)
        │
        ▼
add_is_archived_column
        │
        ▼
5642bd73b6d8 (Notification Fields)
        │
        ▼
add_phone_field_to_user
        │
        ▼
add_vehicle_type_to_driver
        │
        ▼
a8f3c2d91e57 (Delivered At)
        │
        ▼
b7e4d2f1a3c9 (Timestamps, Notes, Driver Code)
        │
        ▼
c8f3a1b2d4e5 (Rename sales_track to sales_taker) ← HEAD
```

---

## Individual Migrations

### 1. `0ad0e83f95f1` - Initial Schema

**File:** `0ad0e83f95f1_initial_schema_simple.py`
**Created:** January 22, 2026
**Revises:** None (Base migration)

**Purpose:** Creates the complete initial database schema for PharmaFleet.

**Tables Created:**
| Table | Description |
|-------|-------------|
| `user` | User accounts with roles, authentication |
| `warehouse` | Warehouse locations with PostGIS geometry |
| `driver` | Driver profiles linked to users and warehouses |
| `order` | Delivery orders with customer info (JSONB) |
| `orderstatushistory` | Audit trail for order status changes |
| `proofofdelivery` | POD with signature/photo URLs |
| `paymentcollection` | Payment records with CASH/KNET/CREDIT_CARD |
| `notification` | Push notification records |
| `driverlocation` | GPS location tracking with PostGIS |
| `auditlog` | General audit logging |

**Key Indexes:**
- `ix_user_email` (unique)
- `ix_warehouse_code` (unique)
- `ix_order_sales_order_number` (unique)
- PostGIS spatial indexes (commented out in code)

**Downgrade:** Drops all tables in reverse dependency order.

---

### 2. `add_is_archived_column` - Archive Flag

**File:** `add_is_archived_column.py`
**Created:** January 27, 2026
**Revises:** `0ad0e83f95f1`

**Purpose:** Adds archive capability to orders for the 24-hour archive buffer feature.

**Changes:**
- Adds `is_archived` BOOLEAN column to `order` table (default: `false`)
- Creates `ix_order_is_archived` index

**Business Rule:** Delivered orders stay visible for 24 hours before being archived by the `/auto-archive` cron endpoint.

**Downgrade:** Drops index and column.

---

### 3. `5642bd73b6d8` - Notification Fields

**File:** `5642bd73b6d8_add_notification_fields.py`
**Created:** January 27, 2026
**Revises:** `add_is_archived_column`

**Purpose:** Adds fields for push notification and driver online tracking.

**Changes:**
- Adds `last_online_at` DATETIME to `driver` table
- Adds `fcm_token` STRING to `user` table (Firebase Cloud Messaging)

**Note:** The downgrade contains PostGIS topology system tables (`layer`, `topology`, `spatial_ref_sys`) that were auto-generated by Alembic autogenerate. These are PostGIS internal tables and should not be recreated - the commented-out `op.drop_table()` calls in upgrade() correctly ignore them.

**Downgrade:** Drops the added columns. Contains extraneous PostGIS table recreation that could be cleaned up.

---

### 4. `add_phone_field_to_user` - User Phone

**File:** `add_phone_field_to_user.py`
**Created:** February 2, 2026
**Revises:** `5642bd73b6d8`

**Purpose:** Adds phone number field for user contact information.

**Changes:**
- Adds `phone` STRING to `user` table (nullable)

**Downgrade:** Drops column.

---

### 5. `add_vehicle_type_to_driver` - Vehicle Type

**File:** `add_vehicle_type_to_driver.py`
**Created:** February 3, 2026
**Revises:** `add_phone_field_to_user`

**Purpose:** Adds vehicle type categorization for drivers.

**Changes:**
- Adds `vehicle_type` STRING to `driver` table (nullable)

**Note:** This supplements the existing `vehicle_info` field which stores free-text vehicle details.

**Downgrade:** Drops column.

---

### 6. `a8f3c2d91e57` - Delivered At Timestamp

**File:** `a8f3c2d91e57_add_delivered_at_to_orders.py`
**Created:** February 4, 2026
**Revises:** `add_vehicle_type_to_driver`

**Purpose:** Tracks when orders are marked as DELIVERED for the 24-hour archive buffer.

**Changes:**
- Adds `delivered_at` DATETIME (timezone-aware) to `order` table
- Creates `ix_order_delivered_at` index

**Business Rule:** Orders are archived 24 hours after `delivered_at` is set, not immediately upon delivery.

**Downgrade:** Drops index and column.

---

### 7. `b7e4d2f1a3c9` - Order Timestamps, Notes, Driver Code

**File:** `b7e4d2f1a3c9_add_order_timestamps_notes_driver_code.py`
**Created:** February 5, 2026
**Revises:** `a8f3c2d91e57`

**Purpose:** Adds detailed order tracking timestamps and driver identification.

**Changes:**
- **Order table:**
  - `assigned_at` DATETIME (timezone-aware) with index
  - `picked_up_at` DATETIME (timezone-aware)
  - `notes` TEXT for free-text order notes
  - `sales_track` STRING for sales tracking (renamed in next migration)
- **Driver table:**
  - `code` STRING (unique) for driver identification
  - Creates `ix_driver_code` unique index

**Business Rule:** Driver `code` defaults to `biometric_id` when not explicitly provided.

**Downgrade:** Drops all added columns and indexes.

---

### 8. `c8f3a1b2d4e5` - Rename sales_track to sales_taker

**File:** `c8f3a1b2d4e5_rename_sales_track_to_sales_taker.py`
**Created:** February 5, 2026
**Revises:** `b7e4d2f1a3c9`

**Purpose:** Renames column to use correct business terminology.

**Changes:**
- Renames `order.sales_track` to `order.sales_taker`

**Important:** All code should use `sales_taker`. The old name `sales_track` is deprecated.

**Downgrade:** Reverts the column name.

---

## How to Run Migrations

### Local Development

```bash
cd backend
source venv/bin/activate  # Linux/macOS
# OR
venv\Scripts\activate     # Windows

# Apply all pending migrations
alembic upgrade head

# Check current revision
alembic current

# View migration history
alembic history

# Downgrade one revision
alembic downgrade -1

# Downgrade to specific revision
alembic downgrade 0ad0e83f95f1
```

### Docker Environment

```bash
# Run migrations inside container
docker exec delivery-system-iii-backend-1 alembic upgrade head

# Check current status
docker exec delivery-system-iii-backend-1 alembic current
```

### Production (Vercel)

Production migrations should be run manually after pulling environment variables:

```bash
vercel env pull .env.vercel --environment=production
cd backend
python -c "
import os
os.environ['DATABASE_URL'] = '<DATABASE_URL from .env.vercel>'
os.environ['SECRET_KEY'] = '<SECRET_KEY from .env.vercel>'
from alembic.config import Config
from alembic import command
command.upgrade(Config('alembic.ini'), 'head')
"
```

### Creating New Migrations

```bash
# Auto-generate migration (requires live DB connection)
alembic revision --autogenerate -m "description_of_changes"

# Create empty migration (no DB required)
alembic revision -m "description_of_changes"
```

---

## Common Issues and Troubleshooting

### 1. Async Engine Configuration

The project uses async SQLAlchemy. The `env.py` is configured for async operations:
- Uses `async_engine_from_config` with `NullPool`
- Requires `statement_cache_size=0` for PgBouncer compatibility

### 2. PostGIS Spatial Tables in Autogenerate

Alembic autogenerate may detect PostGIS system tables (`spatial_ref_sys`, `topology`, `layer`). These should be ignored. The `5642bd73b6d8` migration shows this issue where the downgrade incorrectly recreates these tables.

**Fix:** Add to `env.py`:
```python
def include_object(object, name, type_, reflected, compare_to):
    if name in ('spatial_ref_sys', 'topology', 'layer'):
        return False
    return True

context.configure(
    ...
    include_object=include_object,
)
```

### 3. Non-Standard Revision IDs

Some migrations use human-readable revision IDs instead of auto-generated hex:
- `add_is_archived_column`
- `add_phone_field_to_user`
- `add_vehicle_type_to_driver`

This is functional but inconsistent. Prefer auto-generated IDs for new migrations.

### 4. Timezone-Aware vs Naive Datetimes

Initial schema uses naive `DateTime()`, while later migrations use `DateTime(timezone=True)`. The application uses UTC throughout. Ensure consistency:
- Always use `datetime.now(timezone.utc)` in Python code
- Newer columns correctly use `DateTime(timezone=True)`

### 5. Reset Alembic Version

If you need to reset the migration state (dev only):
```bash
python scripts/drop_alembic.py
alembic upgrade head
```

---

## Recommendations

### Potential Improvements (Do NOT Modify Production Migrations)

1. **Migration Squashing Candidates**

   The following migrations could be squashed into a single migration for new deployments:
   - `add_phone_field_to_user`
   - `add_vehicle_type_to_driver`

   These are simple single-column additions that were created close together. However, since they are in production, they should NOT be modified.

2. **Cleanup PostGIS Autogenerate Issue**

   The `5642bd73b6d8` downgrade contains unnecessary PostGIS table recreation. This should be cleaned in future by adding `include_object` filter to `env.py`.

3. **Standardize Revision IDs**

   Future migrations should use auto-generated hex revision IDs for consistency:
   ```bash
   # Correct
   alembic revision --autogenerate -m "add_new_feature"
   # Generates: a1b2c3d4e5f6_add_new_feature.py

   # Avoid manually naming revisions like "add_phone_field_to_user"
   ```

4. **Consider Data Migration Patterns**

   Current migrations are schema-only. If data migrations are needed in future:
   ```python
   def upgrade():
       # Schema change
       op.add_column('order', sa.Column('new_field', ...))

       # Data migration
       conn = op.get_bind()
       conn.execute(text("UPDATE order SET new_field = ..."))
   ```

5. **Add Migration Tests**

   Consider adding tests that verify migrations can be applied and rolled back:
   ```python
   def test_migrations():
       alembic.command.upgrade(config, "head")
       alembic.command.downgrade(config, "base")
       alembic.command.upgrade(config, "head")
   ```

---

## Schema Summary (Current State)

After all migrations, the database schema includes:

### Users Table
- `id`, `full_name`, `email`, `hashed_password`, `is_active`, `is_superuser`, `role`
- `fcm_token`, `phone`

### Drivers Table
- `id`, `user_id`, `warehouse_id`, `biometric_id`, `vehicle_info`, `is_available`
- `last_online_at`, `vehicle_type`, `code`

### Orders Table
- `id`, `sales_order_number`, `customer_info` (JSONB), `status`, `payment_method`
- `total_amount`, `warehouse_id`, `driver_id`, `created_at`, `updated_at`
- `is_archived`, `delivered_at`, `assigned_at`, `picked_up_at`, `notes`, `sales_taker`

### Other Tables
- `warehouse` - with PostGIS location
- `orderstatushistory` - status audit trail
- `proofofdelivery` - signature/photo URLs
- `paymentcollection` - payment records
- `notification` - push notifications
- `driverlocation` - GPS tracking with PostGIS
- `auditlog` - general audit logging

---

*Last Updated: February 7, 2026*
